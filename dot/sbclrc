;;;; sbclrc -- configuration file for SBCL
;;;; Created   :
;;;; Modified  : <2019-6-14 Fri 21:09:53 BST> Sharlatan
;;;; Author    : Sharlatan <sharlatanus@gmail.com>

;;;; Commentary:

;;;; Code:

(defvar *user-sbcl-src-path*)
(defvar *user-quicklisp-init-path*)
(defvar *user-quicklisp-projects-path*)

(defun from-home-path (path)
  "Build a absolute path to user target directory including $HOME."
  (merge-pathnames path (user-homedir-pathname)))

(setf *user-sbcl-src-path* (from-home-path ".local/src/sbcl/")
      *user-quicklisp-projects-path* (from-home-path "Projects/hck/Lisp/CommonLisp/")
      *user-quicklisp-init-path* (from-home-path ".local/share/common-lisp/setup.lisp"))

;; Path to SBCL source code directory
(when (probe-file *user-sbcl-src-path*)
  (sb-ext:set-sbcl-source-location *user-sbcl-src-path*))

#-quicklisp
(when (probe-file *user-quicklisp-init-path*)
  (load *user-quicklisp-init-path*))

(when (probe-file *user-quicklisp-projects-path*)
  (push *user-quicklisp-projects-path* ql:*local-project-directories*))

(require :asdf)

;;; If a fasl was stale, try to recompile and load (once).
(defmethod asdf:perform :around ((o asdf:load-op)
                                 (c asdf:cl-source-file))
  (handler-case (call-next-method o c)
    ;; If a fasl was stale, try to recompile and load (once).
    (sb-ext:invalid-fasl ()
      (asdf:perform (make-instance 'asdf:compile-op) c)
      (call-next-method))))

;;;; sbclrc ends here
